---
title: "HEATMAP_CODE_WT_NT_KO_NT_AND_KO_P"
author: "David Martínez-Delgado"
date: "2025-07-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}

#####################
# 0. Load libraries #
#####################

suppressPackageStartupMessages({
  library(dplyr)
  library(tibble)
  library(ComplexHeatmap)
  library(circlize)
  library(viridisLite) # cividis’ continua (colorblind-friendly)
  library(svglite)
})

################################
# 1. Reading and preprocessing #
################################

expr_raw <- read.delim(
  "WT_NT_KO_NT_AND_KO_P_VST_TRANSFORMED.txt",
  header           = TRUE,
  sep              = "\t",
  check.names      = FALSE,
  stringsAsFactors = FALSE
)

expr_hp <- expr_raw |>
  column_to_rownames("external_gene_name") |>
  mutate(across(everything(), as.numeric)) |>
  as.matrix()

metadata <- read.csv("Metadata.csv", stringsAsFactors = FALSE)

rownames(metadata) <- metadata$Samples

metadata$Samples   <- NULL

metadata_hp <- subset(metadata, Group %in% c("WT_NT", "KO_NT", "KO_P")) |>
  select(Group)

names(metadata_hp) <- "Condition"

############################################
# Final order and levels: WT → KO → KO + P #
############################################

metadata_hp$Condition <- factor(
  dplyr::case_when(
    grepl("WT_NT", rownames(metadata_hp)) ~ "WT",
    grepl("KO_NT", rownames(metadata_hp)) ~ "KO",
    grepl("KO_P",  rownames(metadata_hp)) ~ "KO + P",
    TRUE ~ metadata_hp$Condition
  ),
  levels = c("WT", "KO", "KO + P")
)

expr_hp <- expr_hp[, rownames(metadata_hp)]

colnames(expr_hp) <- gsub("_WT_NT$", "_WT",  colnames(expr_hp))

colnames(expr_hp) <- gsub("_KO_NT$", "_KO",  colnames(expr_hp))

colnames(expr_hp) <- gsub("_KO_P$",  "_KOP", colnames(expr_hp))

###################################
# 2. Row scaling for the heat map #
###################################

expr_hp_scaled <- t(scale(t(expr_hp)))

###################################
# 3. Palette, cuts and clustering #
###################################

breaksList <- seq(-2, 2, by = 1)
Palette    <- viridisLite::viridis(
  n         = length(breaksList),
  option    = "C",  # ‘cividis’: suitable for most color blindness.
  direction = -1
)

Annotation_color <- list(
  Condition = c("WT"      = "#0072B2",   # Blue.
                "KO"      = "#E69F00",   # Orange.
                "KO + P"  = "#CC79A7")   # Magenta.
)

cluster_rows <- hclust(as.dist(1 - cor(t(expr_hp), method = "pearson")))

cluster_cols <- hclust(as.dist(1 - cor(expr_hp,  method = "pearson")))

######################
# 4. Export function #
######################

save_heatmap <- function(file_stub,
                         show_colnames = FALSE,
                         add_annotation = TRUE) {

  ###########
  # Heatmap #
  ###########
  
  ht_main <- Heatmap(
    expr_hp_scaled,
    name               = "Row Z-Score",
    col                = circlize::colorRamp2(breaksList, Palette),
    cluster_rows       = cluster_rows,
    cluster_columns    = cluster_cols,
    show_row_names     = FALSE,
    show_column_names  = show_colnames,
    column_names_gp    = grid::gpar(fontsize = 8),
    heatmap_legend_param = list(
      title_gp   = grid::gpar(fontsize = 8,  fontfamily = "Arial"),
      labels_gp  = grid::gpar(fontsize = 6,  fontfamily = "Arial")
    ),
    border            = TRUE
  )

  #######################
  # Optional annotation #
  #######################
  
  if (isTRUE(add_annotation)) {
    ha <- HeatmapAnnotation(
      df       = metadata_hp,
      col      = Annotation_color,
      annotation_name_side = "left",
      annotation_height    = unit(6, "mm"),
      annotation_legend_param = list(
        Condition = list(
          title      = "Condition",
          title_gp   = grid::gpar(fontsize = 11, fontfamily = "Arial"),
          labels_gp  = grid::gpar(fontsize = 9,  fontfamily = "Arial"),
          ncol       = 1
        )
      )
    )
    ht <- ha %v% ht_main
  } else {
    ht <- ht_main
  }
  
  ##################################
  # Common routine for PNG and SVG #
  ##################################
  
  export_ht <- function(device_fun, fname, ...) {
    device_fun(fname, width = 8, height = 8, ...)
    on.exit(dev.off(), add = TRUE)
    draw(
      ht,
      heatmap_legend_side    = "right",
      annotation_legend_side = "right",
      gap                    = unit(4, "mm"),
      padding                = unit(c(4, 4, 4, 10), "mm")
    )
  }

  ####################################
  # Export PNG 600 dpi and SVG in WD #
  ####################################
  
  export_ht(
    png,
    paste0(file_stub, ".png"),
    units = "in", res = 600, type = "cairo", family = "Arial"
  )

  export_ht(
    svglite::svglite,
    paste0(file_stub, ".svg"),
    system_fonts = list(serif = "Arial", sans = "Arial", mono = "Arial")
  )
}

##################################
# 5. Generate the three variants #
##################################

save_heatmap("HEATMAP_DEG_FROM_FDR_0_05_FC_1_5_WT_NT_VS_KO_NT_IN_WT_NT_AND_KO_NT_AND_KO_P_VST_PROPRANOLOL_NO_COLUMNS_NAMES_NO_ANNOTATION",
             show_colnames = FALSE, add_annotation = FALSE)

save_heatmap("HEATMAP_DEG_FROM_FDR_0_05_FC_1_5_WT_NT_VS_KO_NT_IN_WT_NT_AND_KO_NT_AND_KO_P_VST_PROPRANOLOL_WITH_COLUMNS_NAMES_WITH_ANNOTATION",
             show_colnames = TRUE,  add_annotation = TRUE)

save_heatmap("HEATMAP_DEG_FROM_FDR_0_05_FC_1_5_WT_NT_VS_KO_NT_IN_WT_NT_AND_KO_NT_AND_KO_P_VST_PROPRANOLOL_WITH_COLUMNS_NAMES_NO_ANNOTATION",
             show_colnames = TRUE,  add_annotation = FALSE)

```

